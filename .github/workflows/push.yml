name: OpenAPI Build

on:
  push:
    branches:
      - feature/*
      - dev/*
      - main
    paths:
      - openapi/**

env:
  IMAGE_NAME: deploy-radiohub-prod/docs
  GCP_PROJECT_ID: swr-lab
  GCP_REGISTRY_DOMAIN: europe-west1-docker.pkg.dev

jobs:
  docker:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.push.outputs.VERSION }}
    steps:
      - name: Checkout repo ðŸ‘€
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup Google Cloud Auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{ secrets.GCP_IAM_ORG_LAB_KEY }}

      - name: ðŸ— Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: ðŸ”‘ Login to Registry
        run: 'gcloud auth configure-docker $GCP_REGISTRY_DOMAIN'

      - name: ðŸš§ Build docker image
        run: docker build ./openapi --file ./openapi/Dockerfile -t image

      - name: ðŸ· Tagging & Pushing docker
        id: push
        run: |
          # Strip git ref prefix from version
          BRANCH=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')  

          # Strip "v" prefix from tag name
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && BRANCH=$(echo $BRANCH | sed -e 's/^v//')

          # Add custom wrapper syntax
          VERSION=git-run${{ github.run_number }}-day$(date +%j)-$BRANCH-${{ github.actor }}-$GITHUB_SHA

          # Push image to registry
          docker tag image $GCP_REGISTRY_DOMAIN/$GCP_PROJECT_ID/$IMAGE_NAME:$VERSION
          docker push $GCP_REGISTRY_DOMAIN/$GCP_PROJECT_ID/$IMAGE_NAME:$VERSION

          # Update var
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          # Print vars
          echo "## Docker Version Tag" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ‘‹ Logout
        run: docker logout
